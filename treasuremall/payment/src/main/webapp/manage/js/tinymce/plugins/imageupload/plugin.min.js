(function() {
    tinymce.create('tinymce.plugins.ImageUploadPlugin', {
        init : function(ed, url) {
            url = tinyMCE.activeEditor.getParam('imageupload_rel') || url;
            var imageUploadUrl = tinyMCE.activeEditor.getParam('imageupload_url');
            var head = document.getElementsByTagName('body')[0];
            var css = document.createElement('link');                       
            css.type = 'text/css';
            css.rel = 'stylesheet';
            css.href = url + '/css/style.css';
            head.appendChild(css);
            
            // Register commands
            ed.addCommand('mceImageUpload', function() {
                $('#image_upload_type').val('tinymce'); 
                $('body').append('<div class="imageUploadBg"></div>');
                var showImageUploadError = function(msg) {
                    $('.imageUploadError').html(msg).show();
                    removeForeground();
                };
                
                var removeForeground = function() {
                    $('.imageUploadFg').remove();
                    $('.imageUploadFgLoading').remove();
                };
                
                var removeBackground = function() {
                    $('.imageUploadBg').remove();
                    $('.imageUploadContainer').remove();
                };
                
                var container = '\
                    <div class="imageUploadContainer mce-container mce-panel mce-window">\
                        <div class="imageUploadContainerInner">\
                            <div class="mce-window-head">\
                                <div class="mce-title">上传音频</div>\
                                <button type="button" class="mce-close">×</button>\
                            </div>\
                            <form action="' + imageUploadUrl + '" method="POST"  enctype="multipart/form-data" id="uploadImageForm">\
                            <div class="mce-container imageUploadFormContainer" hidefocus="1" tabindex="-1">\
                                <div class="mce-container-body">\
                                    <div class="drop_zone">\
                                        <label for="image-upload-area">选择音频文件</label>\
                                        <b class="audio_icon"></b>\
                                        <span id="audio_upload_requirements">大小限制在10MB, MP3</span>\
                                    </div>\
                                    <div class="file_upload_wrapper"><input type="file" name="file" accept=".mp3" id="image-upload-area" class="mce-textbox mce-placeholder" hidefocus="true"></div>\
                                </div>\
                                <p class="imageUploadError"></p>\
                            </div>\
                            </form>\
                            <!--div class="imageUploadConfirmCase mce-panel">\
                                <div class="mce-btn mce-primary">\
                                    <button role="presentation" class="imageUploadSubmit">Upload</button>\
                                </div>\
                                <div class="mce-btn">\
                                    <button role="presentation" class="imageUploadClose">Close</button>\
                                </div>\
                            </div-->\
                        </div>\
                    </div>\
                ';
                
                $('body').append(container);
                
                $('.imageUploadBg, .imageUploadContainer .imageUploadClose, .mce-close').on('click', function(){
                    removeForeground();
                    removeBackground();
                });
                
                $('#uploadImageForm').iframePostForm({
                    json: true,
                    post: function(){
                        // Sending.
                    },
                    complete: function(response){
                       
                        if (typeof response != "object" || response == null) {
                            removeForeground();
                            showImageUploadError('服务端报错');
                        } else {
                            if(response.Status == 'success') {
                               if (typeof response.Records.sourcePath != 'undefined') {
                                   // var tpl = '<img src="../%s" />';
                                    var tpl = '<audio src="%s" controls="" preload="none"></audio>';
                                    ed.insertContent(tpl.replace('%s', response.Records.sourcePath));
                                    ed.focus();
                                    removeForeground();
                                    removeBackground();
                                } else {
                                    showImageUploadError('未知错误!');
                                } 
                            }else {
                               showImageUploadError('请选择正确的音频格式'); 
                            }
                            
                        }
                    }
                });
                
                $('#image-upload-area').on('change', function(){
                    
                    $('.imageUploadError').html('').hide();
                    
                    if ($('#image-upload-area').val() != '') {
                        $('body').append('<div class="imageUploadFg"></div>');
                        $('body').append('<div class="imageUploadFgLoading"></div>');
                        $('#uploadImageForm').submit();
                    } else {
                        showImageUploadError('Please select an image to upload.');
                    }
                    
                });
            });

            // Register buttons
            ed.addButton('imageupload', {
                //icon : 'media',
                title : '上传音频',
                cmd : 'mceImageUpload',
                image : url + '/icon.png'
            });
        }
    });

    tinymce.PluginManager.add('imageupload', tinymce.plugins.ImageUploadPlugin);
})();
